import time
import machine
import ssd1306
import asyncio
import framebuf
import tools
from display import Display

async def main() -> None:

    # Set up the SSD1306 OLED
    i2c = machine.I2C(1, sda=machine.Pin(14), scl=machine.Pin(15))
    if 60 not in i2c.scan():
        print("SSD1306 not detected! Exiting.")
        exit()
    oled = ssd1306.SSD1306_I2C(128, 64, i2c)

    # declare display
    dc:Display = Display(oled)

    # display the centauri graphic during loading
    CENTAURI_GRAPHIC = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xfc\x00\x7f\xc0?\x07\xf8\xe0\xcf\xfc8\x188\xff\x0c\x01\xf0\x00\x1e\x00\x7f\x87\xf8\xe0\xcf\xfcx\x188\xff\x8c\x00\xf0\x00\x1e\x00\xe1\xc6\x00\xf0\xc1\xc0|\x188\xc3\x8c\x00\xd8\x00$\x00\xc0\xc6\x00\xf8\xc1\xc0|\x188\xc1\x8c\x00\x0c\x00d\x01\xc0\x06\x00\xf8\xc1\xc0\xec\x188\xc3\x8c\x00\x06\x00\xc0\x01\xc0\x07\xf8\xdc\xc1\xc0\xce\x188\xff\x8c\x00\x03\x01\x80\x01\xc0\x07\xf8\xcc\xc1\xc1\xc6\x188\xff\x0c\x00\x01\xc7\x00\x01\xc0\x07\x00\xce\xc1\xc1\xc7\x188\xfe\x0c\x00\x00\xfe\x00\x01\xc0\x86\x00\xc7\xc1\xc1\xff\x188\xc7\x0c\x00\x00\xfe\x00\x00\xe0\xc6\x00\xc7\xc1\xc3\xff\x1c8\xc3\x0c\x00\x00\xfe\x00\x00\xf3\xc7\x00\xc3\xc1\xc3\x83\x9cx\xc3\x8c\x00\x00\xfe\x00\x00\x7f\x87\xfc\xc1\xc1\xc7\x03\x8f\xf0\xc1\xcc\x00\x00\xfe\x00\x00?\x07\xf8\xc1\xc0\xc7\x01\x87\xe0\xc1\xcc\x00\x00\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xc7\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x01\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x06\x00\x80\x00p\x03\x00\xf0q\xc8=\xc3\x00\x070\x00\x0c\x00D\x00B$\x82 \x9al\x91$\x90\x88L\x00\xd8\x00$\x00B(\x12 \x84,\x91(P\x88D\x00\xf0\x00\x1e\x00r)\x9e \x04*\x91\xc8P\x8fx\x00\xf0\x00\x1e\x00B(\x02 \x82)\x91(P\x88H\x07\xfc\x00\x7f\xc0B$\x82 \xd3I\x91$\x90\x8cD\x00\xc0\x00\x0e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
    graphic = framebuf.FrameBuffer(CENTAURI_GRAPHIC, 128, 64, framebuf.MONO_HLSB)
    oled.blit(graphic, 0, 0)
    oled.show()

    # Set up variables to contain the most up to date controller input data
    # "ci" short for "controller input"
    ci_ls:bool = False        # left stick clicked in
    ci_rs:bool = False        # right stick clicked in
    ci_back:bool = False      # back button currently pressed
    ci_start:bool = False     # start button currently pressed
    ci_a:bool = False         # a button currently pressed
    ci_b:bool = False         # b button currently pressed
    ci_x:bool = False         # x button currently pressed
    ci_y:bool = False         # y button currently pressed
    ci_up:bool = False        # D-Pad up currently pressed
    ci_right:bool = False     # D-Pad right currently pressed
    ci_down:bool = False      # D-Pad down currently pressed
    ci_left:bool = False      # D-Pad left currently pressed
    ci_lb:bool = False        # Left bumper currently pressed
    ci_rb:bool = False        # right bumper currently pressed
    ci_left_x:float = 0.0     # Left Stick X axis (left/right) = -1.0 to 1.0
    ci_left_y:float = 0.0     # Left Stick Y axis (left/right) = -1.0 to 1.0
    ci_right_x:float = 0.0    # Right Stick X axis (left/right) = -1.0 to 1.0
    ci_right_y:float = 0.0    # Right Stick Y axis (left/right) = -1.0 to 1.0
    ci_lt:float = 0.0         # Left Trigger = 0.0 to 1.0
    ci_rt:float = 0.0         # Right Trigger = 0.0 to 1.0

    # declare xbox controller input variables
    armed:bool = False
    throttle:float = 0.0      # between 0.0 and 1.0
    pitch:float = 0.0         # between -1.0 and 1.0
    roll:float = 0.0          # between -1.0 and 1.0
    yaw:float = 0.0           # between -1.0 and 1.0

    async def continuous_xbox_read() -> None:

        # declare nonlocal (shared) variables
        nonlocal ci_ls
        nonlocal ci_rs
        nonlocal ci_back
        nonlocal ci_start
        nonlocal ci_a
        nonlocal ci_b
        nonlocal ci_x
        nonlocal ci_y
        nonlocal ci_up
        nonlocal ci_right
        nonlocal ci_down
        nonlocal ci_left
        nonlocal ci_lb
        nonlocal ci_rb
        nonlocal ci_left_x
        nonlocal ci_left_y
        nonlocal ci_right_x
        nonlocal ci_right_y
        nonlocal ci_lt
        nonlocal ci_rt

        # Set up UART to receive controller input data from the RPi
        uart = machine.UART(0, baudrate=9600, tx=machine.Pin(16), rx=machine.Pin(17))
        if uart.any(): # clear out the rxbuffer
            uart.read(uart.any())
        rxBuffer:bytearray = bytearray()
        
        while True:
            
            # check if we have any input data to receive from the xbox controller
            ba:int = uart.any()
            if ba > 0:
                rxBuffer.extend(uart.read(ba))
            
            # Do we have a line?
            while True:
                term_loc:int = rxBuffer.find("\r\n".encode())
                if term_loc != -1:

                    # extract the line                    
                    ThisLine:bytes = rxBuffer[0:term_loc+2]
                    rxBuffer = rxBuffer[16:] # keep the rest, trim out that line

                    # unpack it
                    inputs:dict = tools.unpack_controls(ThisLine) # will return None if there was a problem
                    if inputs != None:
                        ci_ls = inputs["ls"]
                        ci_rs = inputs["rs"]
                        ci_back = inputs["back"]
                        ci_start = inputs["start"]
                        ci_a = inputs["a"]
                        ci_b = inputs["b"]
                        ci_x = inputs["x"]
                        ci_y = inputs["y"]
                        ci_up = inputs["up"]
                        ci_right = inputs["right"]
                        ci_down = inputs["down"]
                        ci_left = inputs["left"]
                        ci_lb = inputs["lb"]
                        ci_rb = inputs["rb"]
                        ci_left_x = inputs["left_x"]
                        ci_left_y = inputs["left_y"]
                        ci_right_x = inputs["right_x"]
                        ci_right_y = inputs["right_y"]
                        ci_lt = inputs["lt"]
                        ci_rt = inputs["rt"]
                else:
                    break
                
            await asyncio.sleep(0.025) # 40 times per second

    async def continuous_display() -> None:
        while True:

            # plug in values collected via xbox input
            dc.armed = armed
            dc.throttle = throttle
            dc.pitch = pitch
            dc.roll = roll
            dc.yaw = yaw

            # display
            dc.display()

            # wait
            await asyncio.sleep(0.1)

    # get all threads going
    task_read_xbox = asyncio.create_task(continuous_xbox_read())
    task_display = asyncio.create_task(continuous_display())
    await asyncio.gather(task_read_xbox, task_display)

asyncio.run(main())